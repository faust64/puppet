add     1 check-state
add   100 allow ip from any to any via lo0
add   101 deny ip from any to 127.0.0.0/8
add   102 deny ip from 127.0.0.0/8 to any
add   103 deny tcp from any to any frag
add  1000 allow icmp from me to any
add  1001 allow icmp from any to me
add  1002 allow tcp from me to any keep-state
add  1003 allow udp from me to any
add  1004 allow udp from any to me src-port 53
add  1005 allow tcp from any to any established
<% @local_networks.each do |office, officehash| -%><% @local_networks[office].each do |rlan| -%><% if rlan['name'] == @myvlan -%><% rulenum = 2000 + @netids[office].to_i -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'] -%><% else -%><% vlanid = @all_networks[@myvlan]['netid'] -%><% end -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = @all_networks[@myvlan]['netmsk'] -%><% end -%>add  <%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me setup
<% end -%><% end -%><% end -%><% if @munin_ip != false -%><% @munin_ip.to_enum.with_index(1).each do |host, idx| -%><% rulefromnum = 3200 + idx -%><% ruletonum = 3000 + idx -%>add  <%=rulefromnum%> allow tcp from me to <%=host%>
add  <%=ruletonum%> allow tcp from <%=host%> to <% if @munin_listenaddr != false -%><%=@munin_listenaddr%><% else -%>me<% end -%> dst-port <%=@munin_port%> setup
<% end -%><% end -%><% if @snmp_ip != false -%><% @snmp_ip.to_enum.with_index(1).each do |host, idx| -%><% rulefromnum = 3600 + idx -%><% ruletonum = 3400 + idx -%>add  <%=rulefromnum%> allow tcp from me to <%=host%>
add  <%=ruletonum%> allow udp from <%=host%> to <% if @snmp_listenaddr != false -%><%=@snmp_listenaddr%><% else -%>me<% end -%> dst-port 161 setup
<% end -%><% end -%><% if @nagios_ip != false -%><% @nagios_ip.to_enum.with_index(1).each do |host, idx| -%><% rulefromnum = 4000 + idx -%><% ruletonum = 3800 + idx -%>add  <%=rulefromnum%> allow tcp from me to <%=host%>
add  <%=ruletonum%> allow tcp from <%=host%> to <% if @nagios_listenaddr != false -%><%=@nagios_listenaddr%><% else -%>me<% end -%> dst-port <%=@nagios_port%> setup
<% end -%><% end -%><% @all_networks.each do |vlanname, vlanhash| -%><% if vlanhash['admin'] == true -%><% @local_networks.each do |office, officehash| -%><% @local_networks[office].each do |rlan| -%><% if rlan['name'] == vlanname -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'].to_i -%><% else -%><% vlanid = vlanhash['netid'].to_i -%><% end -%><% rulenum = 4200 + @netids[office].to_i * 1000 + vlanid -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vlanhash['netmsk'] -%><% end -%>add <% if rulenum < 10000 -%> <% end -%><%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 22 setup
<% end -%><% end -%><% end -%><% end -%><% end -%><% @all_openvpns.each do |vpn, vpnhash| -%><% map = vpnhash['mapto'] -%><% if @all_networks[map]['admin'] == true -%><% @ovpn_networks.each do |office, officehash| -%><% @ovpn_networks[office].each do |rlan| -%><% if rlan['name'] == vpn -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'].to_i -%><% else -%><% vlanid = vpnhash['netid'].to_i -%><% end -%><% rulenum = 4200 + @netids[office].to_i * 1000 + vlanid -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vpnhash['netmsk'] -%><% end -%>add <% if rulenum < 10000 -%> <% end -%><%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 22 setup
<% end -%><% end -%><% end -%><% end -%><% end -%><% @all_networks.each do |vlanname, vlanhash| -%><% if vlanhash['admin'] == true -%><% @local_networks.each do |office, officehash| -%><% @local_networks[office].each do |rlan| -%><% if rlan['name'] == vlanname -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'] -%><% else -%><% vlanid = vlanhash['netid'] -%><% end -%><% rulenum = 20000 + @netids[office].to_i * 1000 + vlanid.to_i + 50 %><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vlanhash['netmsk'] -%><% end -%>add <%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 80 setup
<% end -%><% end -%><% end -%><% end -%><% end -%><% @all_openvpns.each do |vpn, vpnhash| -%><% map = vpnhash['mapto'] -%><% if @all_networks[map]['admin'] == true -%><% @ovpn_networks.each do |office, officehash| -%><% @ovpn_networks[office].each do |rlan| -%><% if rlan['name'] == vpn -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'].to_i -%><% else -%><% vlanid = vpnhash['netid'].to_i -%><% end -%><% rulenum = 20000 + @netids[office].to_i * 1000 + vlanid.to_i + 50 -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vpnhash['netmsk'] -%><% end -%>add <%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 80 setup
<% end -%><% end -%><% end -%><% end -%><% end -%><% @all_networks.each do |vlanname, vlanhash| -%><% if vlanhash['admin'] == true -%><% @local_networks.each do |office, officehash| -%><% @local_networks[office].each do |rlan| -%><% if rlan['name'] == vlanname -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'].to_i -%><% else -%><% vlanid = vlanhash['netid'].to_i -%><% end -%><% rulenum = 30000 + @netids[office].to_i * 1000 + vlanid + 42 -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vlanhash['netmsk'] -%><% end -%>add <%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 443 setup
<% end -%><% end -%><% end -%><% end -%><% end -%><% @all_openvpns.each do |vpn, vpnhash| -%><% map = vpnhash['mapto'] -%><% if @all_networks[map]['admin'] == true -%><% @ovpn_networks.each do |office, officehash| -%><% @ovpn_networks[office].each do |rlan| -%><% if rlan['name'] == vpn -%><% if rlan['netid'] =~ /[0-9]/ -%><% vlanid = rlan['netid'].to_i -%><% else -%><% vlanid = vpnhash['netid'].to_i -%><% end -%><% rulenum = 38000 + @netids[office].to_i * 1000 + vlanid + 42 -%><% if rlan['netmsk'] -%><% vlanmsk = rlan['netmsk'] -%><% else -%><% vlanmsk = vpnhash['netmsk'] -%><% end -%>add <%=rulenum%> allow tcp from 10.<%=@netids[office]%>.<%=vlanid%>.0/<%=vlanmsk%> to me dst-port 443 setup
<% end -%><% end -%><% end -%><% end -%><% end -%>add 65000 deny ip from any to any
