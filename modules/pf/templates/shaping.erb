<% if @ipsec_offices != false -%><% [ "adsl", "sdsl", "sip" ].each do |locallink| -%><% if @ipsec_offices[@domain][locallink] =~ /[0-9]\.[0-9]/ -%><% @main_networks.each do |nic| -%><% if nic['addr'] == @ipsec_offices[@domain][locallink] or nic['carpaddr'] == @ipsec_offices[@domain][locallink] and @ipsec_offices[@domain][locallink + "-up"] =~ /[0-9]/ -%><% refbw = @ipsec_offices[@domain][locallink + '-up'].to_i * 1000 / @ipsec_offices.size -%>

altq on <%=nic['name']%> cbq bandwidth <%=@ipsec_offices[@domain][locallink + "-up"]%>Mb qlimit 5000 queue { <% @ipsec_offices.each do |office, remote| -%><% if office != @domain -%><% [ "adsl", "sdsl", "sip" ].each do |remotelink| -%><% if @ipsec_offices[office][remotelink] =~ /[0-9]\.[0-9]/ and @ipsec_offices[office][remotelink + '-down'].to_i > 0 -%><%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%> <% end -%><% end -%><% end -%><% end -%>otherwise-<%=locallink%> }
<% @ipsec_offices.each do |office, remote| -%><% if office != @domain -%><% [ "adsl", "sdsl", "sip" ].each do |remotelink| -%><% if @ipsec_offices[office][remotelink] =~ /[0-9]\.[0-9]/ and @ipsec_offices[office][remotelink + '-down'].to_i > 0 -%><% if @ipsec_offices[office][remotelink + '-down'].to_i * 1000 / @ipsec_offices.size > refbw -%><% bwlimit = refbw -%><% elsif @ipsec_offices[office][remotelink + '-down'].to_i * 102400 > @ipsec_offices[@domain][locallink + '-up'].to_i * 1024 -%><% bwlimit = @ipsec_offices[office][remotelink + '-down'].to_i * 1000 / @ipsec_offices.size -%><% else -%><% bwlimit = refbw -%><% end -%>queue <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%> bandwidth <%=bwlimit%>Kb cbq(ecn)
<% end -%><% end -%><% end -%><% end -%>queue otherwise-<%=locallink%> bandwidth <%=refbw%>Kb cbq(default)
<% @ipsec_offices.each do |office, remote| -%><% if office != @domain -%><% [ "adsl", "sdsl", "sip" ].each do |remotelink| -%><% if @ipsec_offices[office][remotelink] =~ /[0-9]\.[0-9]/ and @ipsec_offices[office][remotelink + '-down'].to_i > 0 -%>match in tagged <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%> queue <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%>
match out tagged <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%> queue <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%>
match out on <%=nic['name']%> to <%=@ipsec_offices[office][remotelink]%> queue <%=office.gsub(/\./, '-')%>-<%=locallink%>-<%=remotelink%>
<% end -%><% end -%><% end -%><% end -%><% end -%><% end -%><% end -%><% end -%><% end -%>
